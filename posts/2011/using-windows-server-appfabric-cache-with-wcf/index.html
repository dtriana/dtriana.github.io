<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="David Triana">
    <meta name="description" content="David Triana&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Windows Server AppFabric Cache with WCF"/>
<meta name="twitter:description" content="When it comes to the need for speed nothing better than a Cache, much better if it’s from Microsoft and is part of Windows as it’s the case with Windows AppFabric Cache.
So how about implementing a cache for WCF?, well, BING will find a couple well written and well explain articles about the matter, the better one being this one:
http://blogical.se/blogs/mikael/archive/2010/09/12/use-appfabric-cache-to-cache-your-wcf-service-response.aspx?CommentPosted=true#commentmessage
At first the code doesn’t work because of the use of a timespan as an attribute, just remark that and it will compile and work great, however there is one little problem."/>

    <meta property="og:title" content="Using Windows Server AppFabric Cache with WCF" />
<meta property="og:description" content="When it comes to the need for speed nothing better than a Cache, much better if it’s from Microsoft and is part of Windows as it’s the case with Windows AppFabric Cache.
So how about implementing a cache for WCF?, well, BING will find a couple well written and well explain articles about the matter, the better one being this one:
http://blogical.se/blogs/mikael/archive/2010/09/12/use-appfabric-cache-to-cache-your-wcf-service-response.aspx?CommentPosted=true#commentmessage
At first the code doesn’t work because of the use of a timespan as an attribute, just remark that and it will compile and work great, however there is one little problem." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidtriana.com/posts/2011/using-windows-server-appfabric-cache-with-wcf/" />
<meta property="article:published_time" content="2011-09-12T15:57:00+00:00" />
<meta property="article:modified_time" content="2011-09-12T15:57:00+00:00" />


    
      <base href="https://davidtriana.com/posts/2011/using-windows-server-appfabric-cache-with-wcf/">
    
    <title>
  Using Windows Server AppFabric Cache with WCF · David Triana
</title>

    
      <link rel="canonical" href="https://davidtriana.com/posts/2011/using-windows-server-appfabric-cache-with-wcf/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://davidtriana.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="https://davidtriana.com/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://davidtriana.com/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://davidtriana.com/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.67.1" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://davidtriana.com/">
      David Triana
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://davidtriana.com/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://davidtriana.com/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Using Windows Server AppFabric Cache with WCF</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2011-09-12T15:57:00Z'>
                September 12, 2011
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              7-minute read
            </span>
          </div>
          
          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://davidtriana.com/tags/uncategorized/">Uncategorized</a></div>

        </div>
      </header>

      <div>
        
        <p>When it comes to the need for speed nothing better than a Cache, much better if it’s from Microsoft and is part of Windows as it’s the case with Windows AppFabric Cache.</p>
<p>So how about implementing a cache for WCF?, well, BING will find a couple well written and well explain articles about the matter, the better one being this one:</p>
<p><a href="http://blogical.se/blogs/mikael/archive/2010/09/12/use-appfabric-cache-to-cache-your-wcf-service-response.aspx?CommentPosted=true#commentmessage">http://blogical.se/blogs/mikael/archive/2010/09/12/use-appfabric-cache-to-cache-your-wcf-service-response.aspx?CommentPosted=true#commentmessage</a></p>
<p>At first the code doesn’t work because of the use of a timespan as an attribute, just remark that and it will compile and work great, however there is one little problem. The key for storing the objects in the cache is based only in the input parameters for the operation. What if you have two different operation with the same parameters? What if you have a couple operations with no parameters? Well, the code fails miserably because it will return a cached object that doesn’t correspond to the called operation.</p>
<p>How to fix this?, by using at least the operation name as part as the key, much better by using the namespace and the service name.</p>
<p>First, add a private variable to the CachingOperationInvoker to keep the operation name:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 1: public class CachingOperationInvoker : IOperationInvoker
</code></pre></div><p>2: {</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 3:    IOperationInvoker \_innerOperationInvoker;
</code></pre></div><p>4:    string _cacheName;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 5:    TimeSpan \_timeOut;
</code></pre></div><p>6:    CacheHelper _cacheHelper;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 7:    string \_operationName;
</code></pre></div><p>8:  </p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 9: public CachingOperationInvoker(
</code></pre></div><p>10:    IOperationInvoker innerOperationInvoker,</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 11:    string cacheName, 
</code></pre></div><p>12:    TimeSpan timeOut,</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 13:    string operationName)
</code></pre></div><p>14: {</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 15:    Trace.WriteLine(&#34;CachingOperationInvoker...&#34;);
</code></pre></div><p>16:    _innerOperationInvoker = innerOperationInvoker;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 17:    \_cacheName = cacheName;
</code></pre></div><p>18:    _timeOut = timeOut;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 19:    \_operationName = operationName;
</code></pre></div><p>20:    _cacheHelper = new CacheHelper(_cacheName);</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 21: }
```

.csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; }

Populate that variable from the parameters in the call ApplyDispatchBehavior in the CacheOperationBehavior class

```
 1: public void ApplyDispatchBehavior(
</code></pre></div><p>2:    OperationDescription operationDescription,</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 3:    DispatchOperation dispatchOperation)
</code></pre></div><p>4: {</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 5:    //Build the operation string using the namespace, 
</code></pre></div><p>6:    //service name and operation name</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 7:    //ie: http://thebestserviceever.com/myservice/myoperation
</code></pre></div><p>8:    string operationDisambiguator =</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 9:        operationDescription.DeclaringContract.Namespace +
</code></pre></div><p>10:        &ldquo;/&rdquo; + operationDescription.DeclaringContract.Name + &ldquo;/&rdquo; +</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 11:        operationDescription.Name;
</code></pre></div><p>12:    // Replace the invoker with our own invoker</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 13:    dispatchOperation.Invoker = 
</code></pre></div><p>14:        new CachingOperationInvoker(dispatchOperation.Invoker,</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 15:        \_cacheName, \_timeOut, operationDisambiguator);
</code></pre></div><p>16: }</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">
.csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; }

And include that variable in the Key by modifying the GetSerializedKey method:

</code></pre></div><p>1: private string GetSerializedKey(object[] inputs)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 2: {
</code></pre></div><p>3:    StringBuilder sb = new StringBuilder();</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 4:  
</code></pre></div><p>5:    foreach (object o in inputs)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 6:    {
</code></pre></div><p>7:        if (o.GetType().FullName ==</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 8:        &#34;System.ServiceModel.Channels.MessagePatterns+PatternMessage&#34;)
</code></pre></div><p>9:        {</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 10:            sb.Append(o.ToString() + &#34;\\r\\n&#34;);
</code></pre></div><p>11:        }</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 12:        else
</code></pre></div><p>13:        {</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 14:            XmlSerializer serializer = new XmlSerializer(o.GetType());
</code></pre></div><p>15:            MemoryStream stream = new MemoryStream();</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 16:  
</code></pre></div><p>17:            serializer.Serialize(stream, o);</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 18:            string paramInput = 
</code></pre></div><p>19:                Encoding.Default.GetString(stream.GetBuffer());</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 20:            sb.Append(paramInput + &#34;\\r\\n&#34;);
</code></pre></div><p>21:        }</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 22:    }
</code></pre></div><p>23:    sb.Append(this._operationName);</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 24:    MD5 md5Hasher = MD5.Create();
</code></pre></div><p>25:    byte[] data =</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 26:        md5Hasher.ComputeHash(
</code></pre></div><p>27:        Encoding.Default.GetBytes(sb.ToString().Trim()));</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 28:    Guid key = new Guid(data);
</code></pre></div><p>29:    return key.ToString();</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"> 30: }
```

.csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; }

That way the key will change for different operations and the cache will happily save the object and WCF performance will improve, specially with slow operations that just query the same data over and over again.

[![image](http://davidtriana.net/image.axd?picture=image_thumb_3.png &#34;image&#34;)](http://davidtriana.net/image.axd?picture=image_3.png)

Another problem with this solution is that the behavior configuration is service wide. What if for some reason I need to apply the cache to a few operations only? what if I need to control that via configuration only?, well, if time permits that will be my next improvement to this code but that will be in another post.

.csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, &#34;Courier New&#34;, courier, monospace; background-color: #ffffff; /\*white-space: pre;\*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; }</code></pre></div>
      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>The content on this site reflect my personal views</p>
      
      
        ©
        
        2020
         David Triana 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>

    </main>

    

    

  </body>

</html>
